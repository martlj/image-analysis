<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Image Thresholding</title>
<style>
    #container {
        text-align: center;
        margin-top: 50px;
    }
    .image-container {
        display: inline-block;
        width: 45%;
    }
    canvas {
        border: 1px solid #000;
        margin: 10px;
        max-width: 100%;
        height: auto;
    }
    #slider-container {
        margin-top: 20px;
    }
</style>
</head>
<body>
<div id="container">
    <input type="file" id="upload" accept="image/*">
    <div id="slider-container">
        <label for="threshold">Threshold Value:</label>
        <input type="range" id="threshold" min="0" max="255" value="127">
        <span id="thresholdValue">127</span>
    </div>
    <button id="otsuButton">Calculate Threshold (Otsu Method)</button>
    <div id="images-container"></div>
</div>

<script>
document.getElementById('upload').addEventListener('change', handleFileSelect);

function handleFileSelect(event) {
    const file = event.target.files[0];
    const reader = new FileReader();

    reader.onload = function(event) {
        const img = new Image();
        img.onload = function() {
            displayImages(img);
        }
        img.src = event.target.result;
    };
    reader.readAsDataURL(file);
}

function displayImages(originalImage) {
    const thresholdSlider = document.getElementById('threshold');
    const thresholdValueDisplay = document.getElementById('thresholdValue');
    const imagesContainer = document.getElementById('images-container');
    
    thresholdSlider.addEventListener('input', function() {
        thresholdValueDisplay.textContent = thresholdSlider.value;
        displayBinaryImage(originalImage, Number(thresholdSlider.value));
    });

    const otsuButton = document.getElementById('otsuButton');
    otsuButton.addEventListener('click', function() {
        const otsuThreshold = calculateOtsuThreshold(originalImage);
        thresholdSlider.value = otsuThreshold;
        thresholdValueDisplay.textContent = otsuThreshold;
        displayBinaryImage(originalImage, otsuThreshold);
    });

    imagesContainer.innerHTML = '';

    const canvasOriginal = createCanvas(originalImage);
    canvasOriginal.classList.add('image-container');
    imagesContainer.appendChild(canvasOriginal);

    const initialThreshold = Number(thresholdSlider.value);
    displayBinaryImage(originalImage, initialThreshold);
}

function createCanvas(image) {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = image.width;
    canvas.height = image.height;
    ctx.drawImage(image, 0, 0);
    return canvas;
}

function displayBinaryImage(originalImage, threshold) {
    const binaryImageData = applyThresholding(originalImage, threshold);
    const binaryImage = new Image();
    binaryImage.src = binaryImageData;
    const canvasBinary = createCanvas(binaryImage);
    canvasBinary.classList.add('image-container');
    document.getElementById('images-container').appendChild(canvasBinary);
}

function applyThresholding(image, threshold) {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = image.width;
    canvas.height = image.height;
    ctx.drawImage(image, 0, 0);

    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const pixels = imageData.data;

    for (let i = 0; i < pixels.length; i += 4) {
        const r = pixels[i];
        const g = pixels[i + 1];
        const b = pixels[i + 2];
        const gray = (r + g + b) / 3;
        const newValue = gray < threshold ? 0 : 255;
        pixels[i] = pixels[i + 1] = pixels[i + 2] = newValue;
    }

    ctx.putImageData(imageData, 0, 0);

    return canvas.toDataURL();
}

function calculateOtsuThreshold(image) {
    const grayValues = getGrayValues(image);
    const histogram = getHistogram(grayValues);
    const totalPixels = image.width * image.height;

    let sum = 0;
    for (let i = 0; i < 256; i++) {
        sum += i * histogram[i];
    }

    let sumB = 0;
    let wB = 0;
    let wF = 0;
    let varMax = 0;
    let threshold = 0;

    for (let t = 0; t < 256; t++) {
        wB += histogram[t];
        if (wB === 0) continue;
        wF = totalPixels - wB;
        if (wF === 0) break;

        sumB += t * histogram[t];
        const mB = sumB / wB;
        const mF = (sum - sumB) / wF;

        const varBetween = wB * wF * (mB - mF) * (mB - mF);

        if (varBetween > varMax) {
            varMax = varBetween;
            threshold = t;
        }
    }

    return threshold;
}

function getGrayValues(image) {
    const canvas = createCanvas(image);
    const ctx = canvas.getContext('2d');
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const pixels = imageData.data;
    const grayValues = [];

    for (let i = 0; i < pixels.length; i += 4) {
        const r = pixels[i];
        const g = pixels[i + 1];
        const b = pixels[i + 2];
        const gray = (r + g + b) / 3;
        grayValues.push(gray);
    }

    return grayValues;
}

function getHistogram(grayValues) {
    const histogram = Array(256).fill(0);
    grayValues.forEach(value => {
        histogram[Math.floor(value)]++;
    });
    return histogram;
}
</script>
</body>
</html>
